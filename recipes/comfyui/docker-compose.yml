services:
  comfyui:
    image: yanwk/comfyui-boot:cu128-slim
    container_name: comfyui
    init: true
    restart: unless-stopped
    ports:
      - "30340:8188"
    volumes:
      - comfyui-storage:/root
      - comfyui-models:/root/ComfyUI/models
      - comfyui-hf-hub:/root/.cache/huggingface/hub
      - comfyui-torch-hub:/root/.cache/torch/hub
      - comfyui-input:/root/ComfyUI/input
      - comfyui-output:/root/ComfyUI/output
      - comfyui-workflows:/root/ComfyUI/user/default/workflows
    environment:
      CLI_ARGS: "${COMFYUI_CLI_ARGS:---disable-xformers}"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8188/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

volumes:
  comfyui-storage:
  comfyui-models:
  comfyui-hf-hub:
  comfyui-torch-hub:
  comfyui-input:
  comfyui-output:
  comfyui-workflows:
