services:
  erpnext-db:
    image: mariadb:10.6
    platform: linux/amd64
    container_name: erpnext-db
    environment:
      - MYSQL_ROOT_PASSWORD={{sullaServicePassword}}
      - MYSQL_DATABASE=erpnext
      - MYSQL_USER=erpnext
      - MYSQL_PASSWORD={{sullaServicePassword}}
    volumes:
      - erpnext-db-data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost --password={{sullaServicePassword}}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
      - --skip-innodb-read-only-compressed

  erpnext-backend:
    image: frappe/erpnext-worker:v15
    platform: linux/amd64
    container_name: erpnext-backend
    depends_on:
      erpnext-db:
        condition: service_healthy
    environment:
      - DB_HOST=erpnext-db
      - DB_PORT=3306
      - REDIS_CACHE=host.docker.internal:30117/0
      - REDIS_QUEUE=host.docker.internal:30117/1
      - REDIS_SOCKETIO=host.docker.internal:30117/2
      - SOCKETIO_PORT=9000
    volumes:
      - erpnext-sites:/home/frappe/frappe-bench/sites
      - erpnext-assets:/home/frappe/frappe-bench/sites/assets:ro
    restart: unless-stopped

  erpnext-frontend:
    image: frappe/erpnext-nginx:v15
    platform: linux/amd64
    container_name: erpnext-frontend
    ports:
      - "30280:8080"
    depends_on:
      erpnext-backend:
        condition: service_started
    environment:
      - BACKEND=erpnext-backend:8000
      - FRAPPE_SITE_NAME_HEADER=localhost
      - SOCKETIO=erpnext-websocket:9000
      - UPSTREAM_REAL_IP_ADDRESS=127.0.0.1
      - UPSTREAM_REAL_IP_HEADER=X-Forwarded-For
      - UPSTREAM_REAL_IP_RECURSIVE=off
    volumes:
      - erpnext-sites:/usr/share/nginx/html/sites
      - erpnext-assets:/usr/share/nginx/html/assets
    restart: unless-stopped

  erpnext-websocket:
    image: frappe/frappe-socketio:v15
    platform: linux/amd64
    container_name: erpnext-websocket
    depends_on:
      erpnext-backend:
        condition: service_started
    volumes:
      - erpnext-sites:/home/frappe/frappe-bench/sites
    restart: unless-stopped

volumes:
  erpnext-db-data:
  erpnext-sites:
  erpnext-assets:
