services:
  erpnext-db:
    image: mariadb:10.6
    platform: linux/amd64
    container_name: erpnext-db
    environment:
      - MYSQL_ROOT_PASSWORD={{sullaServicePassword}}
      - MYSQL_DATABASE=erpnext
      - MYSQL_USER=erpnext
      - MYSQL_PASSWORD={{sullaServicePassword}}
    volumes:
      - erpnext-db-data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost --password={{sullaServicePassword}}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
      - --skip-innodb-read-only-compressed

  erpnext-configurator:
    image: frappe/erpnext-worker:latest
    platform: linux/amd64
    container_name: erpnext-configurator
    depends_on:
      erpnext-db:
        condition: service_healthy
    entrypoint: ["bash", "-c"]
    command:
      - >
        ls -1 apps > sites/apps.txt;
        bench set-config -g db_host erpnext-db;
        bench set-config -g db_port 3306;
        bench set-config -g redis_cache redis://host.docker.internal:30117/10;
        bench set-config -g redis_queue redis://host.docker.internal:30117/11;
        bench set-config -g redis_socketio redis://host.docker.internal:30117/12;
        bench set-config -g socketio_port 9000;
        if [ ! -f sites/localhost/site_config.json ]; then
          bench new-site localhost
            --mariadb-root-password={{sullaServicePassword}}
            --admin-password={{sullaServicePassword}}
            --install-app erpnext
            --set-default;
        fi
    volumes:
      - erpnext-sites:/home/frappe/frappe-bench/sites
      - erpnext-assets:/home/frappe/frappe-bench/sites/assets

  erpnext-backend:
    image: frappe/erpnext-worker:latest
    platform: linux/amd64
    container_name: erpnext-backend
    depends_on:
      erpnext-configurator:
        condition: service_completed_successfully
    volumes:
      - erpnext-sites:/home/frappe/frappe-bench/sites
      - erpnext-assets:/home/frappe/frappe-bench/sites/assets:ro
    restart: unless-stopped

  erpnext-frontend:
    image: frappe/erpnext-nginx:latest
    platform: linux/amd64
    container_name: erpnext-frontend
    ports:
      - "30280:8080"
    depends_on:
      erpnext-backend:
        condition: service_started
    environment:
      - BACKEND=erpnext-backend:8000
      - FRAPPE_SITE_NAME_HEADER=localhost
      - SOCKETIO=erpnext-websocket:9000
      - UPSTREAM_REAL_IP_ADDRESS=127.0.0.1
      - UPSTREAM_REAL_IP_HEADER=X-Forwarded-For
      - UPSTREAM_REAL_IP_RECURSIVE=off
    volumes:
      - erpnext-sites:/usr/share/nginx/html/sites
      - erpnext-assets:/usr/share/nginx/html/assets
    restart: unless-stopped

  erpnext-websocket:
    image: frappe/frappe-socketio:latest
    platform: linux/amd64
    container_name: erpnext-websocket
    depends_on:
      erpnext-configurator:
        condition: service_completed_successfully
    volumes:
      - erpnext-sites:/home/frappe/frappe-bench/sites
    restart: unless-stopped

volumes:
  erpnext-db-data:
  erpnext-sites:
  erpnext-assets:
