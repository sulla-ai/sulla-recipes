services:
  novu-api:
    image: ghcr.io/novuhq/novu/api:3.14.0
    container_name: novu-api
    ports:
      - "30250:3000"
    environment:
      - NODE_ENV=production
      - MONGO_URL=mongodb://novu-mongo:27017/novu
      - REDIS_HOST=novu-redis
      - REDIS_PORT=6379
      - API_ROOT_URL=http://novu-api:3000
      - FRONT_BASE_URL=http://localhost:30252
      - NEW_RELIC_ENABLED=false
      - JWT_SECRET={{sullaN8nEncryptionKey}}
      - NOVU_SECRET_KEY={{sullaN8nEncryptionKey}}
      - STORE_ENCRYPTION_KEY={{sullaN8nEncryptionKey|md5}}
    depends_on:
      novu-mongo:
        condition: service_healthy
      novu-redis:
        condition: service_started
    restart: unless-stopped

  novu-dashboard:
    image: ghcr.io/novuhq/novu/dashboard:3.14.0
    container_name: novu-dashboard
    ports:
      - "30252:4000"
    environment:
      - VITE_API_HOSTNAME=http://localhost:30250
      - VITE_WEBSOCKET_HOSTNAME=http://localhost:30253
      - VITE_SELF_HOSTED=true
    restart: unless-stopped

  novu-ws:
    image: ghcr.io/novuhq/novu/ws:3.14.0
    container_name: novu-ws
    ports:
      - "30253:3002"
    environment:
      - NODE_ENV=production
      - PORT=3002
      - MONGO_URL=mongodb://novu-mongo:27017/novu
      - REDIS_HOST=novu-redis
      - REDIS_PORT=6379
      - JWT_SECRET={{sullaN8nEncryptionKey}}
      - NEW_RELIC_ENABLED=false
    depends_on:
      novu-mongo:
        condition: service_healthy
      novu-redis:
        condition: service_started
    restart: unless-stopped

  novu-worker:
    image: ghcr.io/novuhq/novu/worker:3.14.0
    container_name: novu-worker
    environment:
      - NODE_ENV=production
      - MONGO_URL=mongodb://novu-mongo:27017/novu
      - REDIS_HOST=novu-redis
      - REDIS_PORT=6379
      - API_ROOT_URL=http://novu-api:3000
      - NEW_RELIC_ENABLED=false
      - NOVU_SECRET_KEY={{sullaN8nEncryptionKey}}
      - STORE_ENCRYPTION_KEY={{sullaN8nEncryptionKey|md5}}
    depends_on:
      novu-api:
        condition: service_started
      novu-redis:
        condition: service_started
    restart: unless-stopped

  novu-redis:
    image: redis:alpine
    container_name: novu-redis
    restart: unless-stopped

  novu-mongo:
    image: mongo:7
    container_name: novu-mongo
    ports:
      - "30251:27017"
    volumes:
      - novu-mongo-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

volumes:
  novu-mongo-data:
